#!/usr/bin/env php
<?php

use ZnCore\Base\Helpers\InstanceHelper;
use ZnCore\Base\Libs\App\Factories\ApplicationFactory;
use ZnCore\Base\Libs\App\Factories\KernelFactory;
use ZnCore\Base\Libs\DotEnv\DotEnv;

require __DIR__ . '/../../../autoload.php';

DotEnv::init();

if(DotEnv::has('BUNDLES_CONFIG_FILE')) {
    $bundles = include __DIR__ . '/../../../../' . DotEnv::get('BUNDLES_CONFIG_FILE');
} else {
    $bundles = [];
}

$bundleClasses = [
    ZnCore\Base\Libs\App\Bundle::class,
    ZnTool\Package\Bundle::class,
    ZnLib\Db\Bundle::class,
    ZnLib\Fixture\Bundle::class,
    ZnLib\Migration\Bundle::class,
    ZnTool\Generator\Bundle::class,
    ZnTool\Stress\Bundle::class,
    ZnBundle\Queue\Bundle::class,
];

foreach ($bundleClasses as $bundleClass) {
    if(class_exists($bundleClass)) {
        $isDefined = false;
        foreach ($bundles as $bundleInstance) {
            if($bundleInstance instanceof $bundleClass) {
                $isDefined = true;
                break;
            }
        }
        if(!$isDefined) {
            $bundleInstance = InstanceHelper::create($bundleClass, [['all']]);
            $bundles[] = $bundleInstance;
        }
    }
}

$kernel = KernelFactory::createConsoleKernel($bundles);
$application = ApplicationFactory::createConsole($kernel);
$application->run();
